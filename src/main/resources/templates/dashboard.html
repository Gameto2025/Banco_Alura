<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Churn – Banco Alura</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--alto:#dc3545;--medio:#fd7e14;--bajo:#20c997;--muybajo:#0d6efd}
body{background:#f4f7f6}
.chart-container{height:280px}
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark">
<div class="container-fluid">
<span class="navbar-brand">Dashboard Churn Banco Alura</span>
<div>
<button class="btn btn-light btn-sm me-2" onclick="location.href='/'">Nueva Predicción</button>
<button class="btn btn-info btn-sm" onclick="cargarDatos()">Refrescar</button>
</div>
</div>
</nav>

<div class="container-fluid mt-4">

<div class="row g-3 mb-4">
<div class="col"><div class="card p-3 text-center"><div id="totalClientes" class="fs-3 fw-bold">0</div>Evaluados</div></div>
<div class="col"><div class="card p-3 text-center"><div id="totalChurn" class="fs-3 fw-bold text-danger">0</div>Probable Churn</div></div>
<div class="col"><div class="card p-3 text-center"><div id="tasaChurn" class="fs-3 fw-bold">0%</div>Tasa</div></div>
<div class="col"><div class="card p-3 text-center"><div id="scorePromedio" class="fs-3 fw-bold text-success">0%</div>Confianza AI</div></div>
</div>

<div class="row g-4">

<div class="col-xl-4">
<div class="card">
<div class="card-header fw-bold">Distribución de Riesgo</div>
<div class="card-body chart-container">
<canvas id="graficoRiesgo"></canvas>
</div>
</div>
</div>

<div class="col-xl-8">
<div class="card">
<div class="card-header fw-bold text-danger">⚠ Clientes Críticos (Score ≥ 80%)</div>
<table class="table table-striped mb-0">
<thead class="table-dark">
<tr>
<th>ID</th><th>Edad</th><th>País</th><th>Score</th><th>Riesgo</th><th>Causa</th><th>Recomendación</th>
</tr>
</thead>
<tbody id="tablaCriticos"></tbody>
</table>
</div>
</div>

<div class="col-12">
<div class="card">
<div class="card-header fw-bold">Todos los clientes</div>
<table class="table table-sm mb-0">
<thead><tr><th>ID</th><th>Edad</th><th>Score</th><th>Riesgo</th><th>Resultado</th><th>Fecha</th></tr></thead>
<tbody id="tablaClientesBody"></tbody>
</table>
</div>
</div>

</div>
</div>

<script>
let chart=null;

async function cargarDatos(){
const [s,c,a]=await Promise.all([
fetch('/api/churn/estadisticas'),
fetch('/api/churn/criticos'),
fetch('/api/churn/clientes')
]);
const stats=await s.json();
const criticos=await c.json();
const clientes=await a.json();

totalClientes.textContent=stats.totalClientes;
totalChurn.textContent=stats.churns;
tasaChurn.textContent=stats.tasaChurn;
scorePromedio.textContent=stats.scorePromedio;

renderGrafico(stats.distribucionRiesgo||{});

tablaCriticos.innerHTML = criticos.map(c=>{
const score = Number(c.score).toFixed(2);
const riesgo = score >= 90 ? 'ALTO' : 'MEDIO';
const color = score >= 90 ? 'bg-danger' : 'bg-warning';
return `
<tr>
<td>#${c.id}</td>
<td>${c.edad}</td>
<td>${c.pais}</td>
<td>${(c.score * 100).toFixed(2)}%</td>
<td><span class="badge ${color}">${riesgo}</span></td>
<td>${c.factores}</td>
<td><span class="badge bg-warning text-dark">${c.recomendacion}</span></td>
</tr>`}).join('');

tablaClientesBody.innerHTML = clientes.map(c=>`
<tr>
<td>#${c.id}</td>
<td>${c.edad}</td>
<td>${c.score}</td> 
<td>${c.nivelRiesgo}</td>
<td>${c.resultado}</td>
<td>${c.fecha}</td>
</tr>`).join('');
}

function renderGrafico(dist={}){
if(chart) chart.destroy();
chart=new Chart(document.getElementById('graficoRiesgo'),{
type:'doughnut',
data:{labels:['ALTO','MEDIO','BAJO','MUY BAJO'],
datasets:[{data:[dist.ALTO||0,dist.MEDIO||0,dist.BAJO||0,dist['MUY BAJO']||0],
backgroundColor:['#dc3545','#fd7e14','#20c997','#0d6efd']}]},
options:{responsive:true,maintainAspectRatio:false,cutout:'70%'}
});
}

document.addEventListener('DOMContentLoaded', cargarDatos);
</script>
</body>
</html>
